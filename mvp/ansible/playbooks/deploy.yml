---
- name: Deploy Kiran Bot MVP
  hosts: kirin_servers
  become: yes
  vars:
    project_dir: /opt/kirin-bot
    docker_compose_version: "2.24.0"

  tasks:
    - name: Ensure Docker is installed
      include_role:
        name: docker

    - name: Ensure project directory exists
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: '0755'

    - name: Copy project files
      copy:
        src: "{{ playbook_dir }}/../../"
        dest: "{{ project_dir }}"
        exclude:
          - .git
          - node_modules
          - dist
          - output

    - name: Ensure .env file exists
      stat:
        path: "{{ project_dir }}/.env"
      register: env_file

    - name: Fail if .env file is missing
      fail:
        msg: ".env file is required. Copy .env.example to .env and configure it."
      when: not env_file.stat.exists

    - name: Create output directory
      file:
        path: "{{ project_dir }}/output"
        state: directory
        mode: '0755'

    - name: Pull latest Docker images
      docker_compose:
        project_src: "{{ project_dir }}/mvp"
        pull: yes
        files:
          - "{{ project_dir }}/mvp/docker-compose.yml"

    - name: Build and start services
      docker_compose:
        project_src: "{{ project_dir }}/mvp"
        build: yes
        state: started
        files:
          - "{{ project_dir }}/mvp/docker-compose.yml"

    - name: Wait for application to complete
      wait_for:
        timeout: 300
      register: wait_result

    - name: Display summary file location
      debug:
        msg: "Summary file should be available at {{ project_dir }}/output/"

