<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.2rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .tab {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            margin-bottom: 1rem;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .collector-item {
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .collector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .collector-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .interests-list {
            list-style: none;
            padding: 0;
        }
        
        .interest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .queue-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .queue-table th,
        .queue-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .queue-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }
        
        .queue-table tr:hover {
            background: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .summary-item {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        
        .summary-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .summary-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
        }
        
        .summary-text {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .summary-text.expanded {
            max-height: none;
        }
        
        .raw-messages {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        
        .raw-messages.expanded {
            max-height: none;
        }
        
        .message-item {
            padding: 0.5rem;
            border-left: 3px solid #667eea;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        
        .message-author {
            font-weight: bold;
            color: #667eea;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #999;
            margin-left: 0.5rem;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .expand-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 0.9rem;
            text-decoration: underline;
        }
        
        .expand-btn:hover {
            color: #764ba2;
        }
        
        .settings-form {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .settings-form.show {
            display: block;
        }
        
        .settings-form .form-group {
            margin-bottom: 0.75rem;
        }
        
        .settings-form label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .settings-form input,
        .settings-form select,
        .settings-form textarea {
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        
        .settings-form textarea {
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }
        
        .settings-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .channel-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .channel-tag {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .channel-tag .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
        }
        
        .add-channel-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .add-channel-form input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶í Kirin Dashboard</h1>
            <p class="subtitle">Self-hosted LLM-powered content filtering</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('summaries')">üìù Summaries</button>
            <button class="tab" onclick="showTab('collectors')">üîß Collectors</button>
            <button class="tab" onclick="showTab('processor')">‚öôÔ∏è Processor</button>
            <button class="tab" onclick="showTab('interests')">üéØ Interests</button>
            <button class="tab" onclick="showTab('queues')">üìã Queues</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="grid">
                <div class="stat-card">
                    <div class="stat-label">Active Collectors</div>
                    <div class="stat-value" id="stat-collectors">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value" id="stat-jobs">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Summaries Generated</div>
                    <div class="stat-value" id="stat-summaries">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Interests</div>
                    <div class="stat-value" id="stat-interests">-</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button onclick="triggerAllCollectors()">‚ñ∂Ô∏è Run All Collectors</button>
                    <button onclick="showTab('summaries')" class="btn-secondary">üìù View Summaries</button>
                    <button onclick="showTab('processor')" class="btn-secondary">‚öôÔ∏è Update Prompts</button>
                    <button onclick="showTab('interests')" class="btn-secondary">üéØ Manage Interests</button>
                    <button onclick="location.reload()" class="btn-secondary">üîÑ Refresh Data</button>
                </div>
            </div>
        </div>
        
        <!-- Summaries Tab -->
        <div id="summaries-tab" class="tab-content">
            <div class="card">
                <h2>Generated Summaries</h2>
                <div id="message-summaries" class="message"></div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div class="filters" style="flex: 1; margin-bottom: 0;">
                        <div class="filter-group">
                            <label for="filter-source">Filter by Source</label>
                            <select id="filter-source" onchange="loadSummaries()">
                                <option value="">All Sources</option>
                                <option value="slack">Slack</option>
                                <option value="signal">Signal</option>
                                <option value="twitter">Twitter</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-limit">Show</label>
                            <select id="filter-limit" onchange="loadSummaries()">
                                <option value="10">10 summaries</option>
                                <option value="20" selected>20 summaries</option>
                                <option value="50">50 summaries</option>
                                <option value="100">100 summaries</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="generateNewSummary()" class="btn-success">
                            üöÄ Generate New Summary
                        </button>
                        <button onclick="loadSummaries()" class="btn-secondary">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
                
                <div id="summaries-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading summaries...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collectors Tab -->
        <div id="collectors-tab" class="tab-content">
            <div class="card">
                <h2>Collector Management</h2>
                <div id="message-collectors" class="message"></div>
                <div id="collectors-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading collectors...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Processor Tab -->
        <div id="processor-tab" class="tab-content">
            <div class="card">
                <h2>Processor Configuration</h2>
                <div id="message-processor" class="message"></div>
                <form id="processor-form" onsubmit="updateProcessor(event)">
                    <div class="form-group">
                        <label for="ollama-model">LLM Model</label>
                        <input type="text" id="ollama-model" placeholder="qwen2.5:32b" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperature">Temperature (0.0 - 1.0)</label>
                        <input type="number" id="temperature" min="0" max="1" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="concurrency">Concurrency</label>
                        <input type="number" id="concurrency" min="1" max="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="system-prompt">System Prompt</label>
                        <textarea id="system-prompt" required></textarea>
                    </div>
                    
                    <button type="submit">üíæ Save Processor Configuration</button>
                </form>
            </div>
        </div>
        
        <!-- Interests Tab -->
        <div id="interests-tab" class="tab-content">
            <div class="card">
                <h2>User Interests</h2>
                <div id="message-interests" class="message"></div>
                
                <form id="interest-form" onsubmit="addInterest(event)">
                    <div class="form-group">
                        <label for="keyword">Keyword</label>
                        <input type="text" id="keyword" placeholder="e.g., machine learning" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight">Weight (importance)</label>
                        <input type="number" id="weight" min="0.1" max="5" step="0.1" value="1.0" required>
                    </div>
                    
                    <button type="submit">‚ûï Add Interest</button>
                </form>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Current Interests</h3>
                <ul id="interests-list" class="interests-list">
                    <li class="loading">Loading interests...</li>
                </ul>
            </div>
        </div>
        
        <!-- Queues Tab -->
        <div id="queues-tab" class="tab-content">
            <div class="card">
                <h2>Job Queues Status</h2>
                <table class="queue-table" id="queues-table">
                    <thead>
                        <tr>
                            <th>Queue Name</th>
                            <th>Waiting</th>
                            <th>Active</th>
                            <th>Completed</th>
                            <th>Failed</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="loading">Loading queue data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load data for the tab
            if (tabName === 'summaries') loadSummaries();
            if (tabName === 'collectors') loadCollectors();
            if (tabName === 'processor') loadProcessor();
            if (tabName === 'interests') loadInterests();
            if (tabName === 'queues') loadQueues();
        }
        
        // Show message
        function showMessage(elementId, text, isError = false) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = 'message show ' + (isError ? 'message-error' : 'message-success');
            setTimeout(() => msg.classList.remove('show'), 5000);
        }
        
        // Load collectors
        async function loadCollectors() {
            try {
                const response = await fetch('/api/collectors');
                const collectors = await response.json();
                
                const html = collectors.map(c => {
                    const settings = c.settings || {};
                    const isSlack = c.name === 'slack';
                    
                    return `
                        <div class="collector-item">
                            <div class="collector-header">
                                <div>
                                    <div class="collector-name">${c.displayName}</div>
                                    <small>Schedule: ${c.schedulePattern}</small>
                                </div>
                                <div>
                                    <span class="badge ${c.enabled ? 'badge-success' : 'badge-danger'}">
                                        ${c.enabled ? '‚úì Enabled' : '‚úó Disabled'}
                                    </span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button onclick="toggleCollector('${c.name}', ${!c.enabled})">
                                    ${c.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                                </button>
                                <button onclick="triggerCollector('${c.name}')" class="btn-success" ${!c.enabled ? 'disabled' : ''}>
                                    üöÄ Trigger Now
                                </button>
                                <button onclick="toggleSettings('${c.name}')" class="btn-secondary">
                                    ‚öôÔ∏è Settings
                                </button>
                            </div>
                            
                            <!-- Settings Form -->
                            <div class="settings-form" id="settings-${c.name}">
                                <h3 style="margin-bottom: 1rem; color: #667eea;">‚öôÔ∏è ${c.displayName} Settings</h3>
                                
                                <form onsubmit="saveCollectorSettings(event, '${c.name}')">
                                    <div class="form-group">
                                        <label for="schedule-${c.name}">Schedule Pattern (Cron)</label>
                                        <input type="text" id="schedule-${c.name}" 
                                               value="${c.schedulePattern}" required>
                                        <div class="settings-help">
                                            Examples: "*/30 * * * *" (every 30 min), "0 */6 * * *" (every 6 hours)
                                        </div>
                                    </div>
                                    
                                    ${isSlack ? `
                                        <div class="form-group">
                                            <label>Slack Channels</label>
                                            <div class="channel-list" id="channels-${c.name}">
                                                ${(settings.channelIds || []).map(ch => `
                                                    <div class="channel-tag">
                                                        <span>${ch}</span>
                                                        <button type="button" class="remove-btn" 
                                                                onclick="removeChannel('${c.name}', '${ch}')">√ó</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="add-channel-form">
                                                <input type="text" id="new-channel-${c.name}" 
                                                       placeholder="Channel ID (e.g., C1234567890)">
                                                <button type="button" onclick="addChannel('${c.name}')">
                                                    ‚ûï Add
                                                </button>
                                            </div>
                                            <div class="settings-help">
                                                Find channel IDs in Slack: Right-click channel ‚Üí View channel details ‚Üí Copy ID
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="lookback-${c.name}">Lookback Hours</label>
                                            <input type="number" id="lookback-${c.name}" 
                                                   value="${settings.lookbackHours || 24}" 
                                                   min="1" max="720" required>
                                            <div class="settings-help">
                                                How far back to fetch messages (1-720 hours, max 30 days)
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                        <button type="submit" class="btn-success">üíæ Save Settings</button>
                                        <button type="button" onclick="toggleSettings('${c.name}')" class="btn-secondary">
                                            ‚úñÔ∏è Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('collectors-list').innerHTML = html;
            } catch (error) {
                document.getElementById('collectors-list').innerHTML = '<p>Error loading collectors</p>';
            }
        }
        
        // Toggle collector
        async function toggleCollector(name, enable) {
            try {
                const response = await fetch(`/api/collectors/${name}/toggle`, {
                    method: 'POST'
                });
                const result = await response.json();
                showMessage('message-collectors', result.message);
                loadCollectors();
                loadOverview();
            } catch (error) {
                showMessage('message-collectors', 'Error toggling collector', true);
            }
        }
        
        // Toggle settings panel
        function toggleSettings(name) {
            const element = document.getElementById(`settings-${name}`);
            element.classList.toggle('show');
        }
        
        // Store current channel lists
        const collectorChannels = {};
        
        // Add channel to collector
        function addChannel(collectorName) {
            const input = document.getElementById(`new-channel-${collectorName}`);
            const channelId = input.value.trim();
            
            if (!channelId) {
                alert('Please enter a channel ID');
                return;
            }
            
            // Validate channel ID format (starts with C and has more characters)
            if (!channelId.match(/^[A-Z][A-Z0-9]{8,}$/)) {
                alert('Invalid channel ID format. Should be like: C1234567890');
                return;
            }
            
            // Initialize array if needed
            if (!collectorChannels[collectorName]) {
                collectorChannels[collectorName] = [];
            }
            
            // Check for duplicates
            if (collectorChannels[collectorName].includes(channelId)) {
                alert('Channel already added');
                return;
            }
            
            // Add to temporary storage
            collectorChannels[collectorName].push(channelId);
            
            // Update display
            const container = document.getElementById(`channels-${collectorName}`);
            const tag = document.createElement('div');
            tag.className = 'channel-tag';
            tag.innerHTML = `
                <span>${channelId}</span>
                <button type="button" class="remove-btn" onclick="removeChannel('${collectorName}', '${channelId}')">√ó</button>
            `;
            container.appendChild(tag);
            
            // Clear input
            input.value = '';
        }
        
        // Remove channel from collector
        function removeChannel(collectorName, channelId) {
            if (!confirm(`Remove channel ${channelId}?`)) return;
            
            // Remove from temporary storage
            if (collectorChannels[collectorName]) {
                collectorChannels[collectorName] = collectorChannels[collectorName].filter(c => c !== channelId);
            }
            
            // Reload to refresh display
            loadCollectors();
        }
        
        // Save collector settings
        async function saveCollectorSettings(event, collectorName) {
            event.preventDefault();
            
            const schedulePattern = document.getElementById(`schedule-${collectorName}`).value;
            const settings = {};
            
            // Get Slack-specific settings
            if (collectorName === 'slack') {
                const lookbackHours = parseInt(document.getElementById(`lookback-${collectorName}`).value);
                
                // Get channel IDs from the display
                const channelTags = document.querySelectorAll(`#channels-${collectorName} .channel-tag span`);
                const channelIds = Array.from(channelTags).map(tag => tag.textContent.trim());
                
                if (channelIds.length === 0) {
                    alert('Please add at least one channel');
                    return;
                }
                
                settings.channelIds = channelIds;
                settings.lookbackHours = lookbackHours;
            }
            
            try {
                const response = await fetch(`/api/collectors/${collectorName}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedulePattern,
                        settings
                    })
                });
                
                if (response.ok) {
                    showMessage('message-collectors', `‚úÖ ${collectorName} settings saved successfully!`);
                    toggleSettings(collectorName);
                    loadCollectors();
                    loadOverview();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save settings');
                }
            } catch (error) {
                showMessage('message-collectors', `Error saving settings: ${error.message}`, true);
            }
        }
        
        // Trigger collector
        async function triggerCollector(name) {
            try {
                const response = await fetch(`/api/collectors/${name}/trigger`, {
                    method: 'POST'
                });
                const result = await response.json();
                showMessage('message-collectors', result.message || 'Collector job queued successfully!');
                setTimeout(loadQueues, 1000);
            } catch (error) {
                showMessage('message-collectors', 'Error triggering collector', true);
            }
        }
        
        // Trigger all collectors
        async function triggerAllCollectors() {
            const collectors = ['slack', 'signal', 'twitter'];
            let success = 0;
            for (const name of collectors) {
                try {
                    await fetch(`/api/collectors/${name}/trigger`, { method: 'POST' });
                    success++;
                } catch (error) {
                    console.error(`Error triggering ${name}:`, error);
                }
            }
            alert(`Triggered ${success} collector(s)`);
            setTimeout(loadQueues, 1000);
        }
        
        // Load summaries
        async function loadSummaries() {
            try {
                const source = document.getElementById('filter-source').value;
                const limit = document.getElementById('filter-limit').value;
                
                let url = `/api/summaries?limit=${limit}`;
                if (source) url += `&source=${source}`;
                
                const response = await fetch(url);
                const summaries = await response.json();
                
                if (summaries.length === 0) {
                    document.getElementById('summaries-list').innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">No summaries yet. Trigger a collector to generate some!</p>';
                    return;
                }
                
                const html = summaries.map(s => {
                    const date = new Date(s.createdAt);
                    const formattedDate = date.toLocaleString();
                    const messageCount = s.messageIds?.length || 0;
                    
                    return `
                        <div class="summary-item">
                            <div class="summary-header">
                                <div>
                                    <span class="badge badge-success">${s.source.toUpperCase()}</span>
                                    <span style="margin-left: 1rem; color: #999; font-size: 0.9rem;">${formattedDate}</span>
                                </div>
                                <div class="summary-meta">
                                    <span>üì® ${messageCount} messages</span>
                                    ${s.relevanceScore ? `<span>‚≠ê ${s.relevanceScore.toFixed(2)}</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="summary-text" id="summary-${s.id}">
                                ${escapeHtml(s.summary)}
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="expand-btn" onclick="toggleExpand('summary-${s.id}')">
                                    üìñ Toggle Full Text
                                </button>
                                <button class="expand-btn" onclick="toggleRawMessages('${s.id}')">
                                    üí¨ Toggle Raw Messages
                                </button>
                            </div>
                            
                            <div class="raw-messages" id="raw-${s.id}" style="display: none;">
                                ${(s.rawMessages || []).map(m => `
                                    <div class="message-item">
                                        <span class="message-author">${escapeHtml(m.author)}</span>
                                        <span class="message-time">${new Date(parseInt(m.timestamp) * 1000).toLocaleString()}</span>
                                        <div style="margin-top: 0.5rem;">${escapeHtml(m.text)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('summaries-list').innerHTML = html;
            } catch (error) {
                document.getElementById('summaries-list').innerHTML = '<p>Error loading summaries</p>';
                console.error('Error loading summaries:', error);
            }
        }
        
        // Toggle expand summary text
        function toggleExpand(id) {
            const element = document.getElementById(id);
            element.classList.toggle('expanded');
        }
        
        // Toggle raw messages
        function toggleRawMessages(id) {
            const element = document.getElementById('raw-' + id);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Generate new summary by triggering all enabled collectors
        async function generateNewSummary() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generating...';
                
                // Get all enabled collectors
                const response = await fetch('/api/collectors');
                const collectors = await response.json();
                const enabledCollectors = collectors.filter(c => c.enabled);
                
                if (enabledCollectors.length === 0) {
                    showMessage('message-summaries', 'No collectors are enabled. Please enable at least one collector first.', true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Trigger all enabled collectors
                let triggered = 0;
                for (const collector of enabledCollectors) {
                    try {
                        await fetch(`/api/collectors/${collector.name}/trigger`, { method: 'POST' });
                        triggered++;
                    } catch (error) {
                        console.error(`Failed to trigger ${collector.name}:`, error);
                    }
                }
                
                if (triggered === 0) {
                    showMessage('message-summaries', 'Failed to trigger any collectors', true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Show progress message
                showMessage('message-summaries', `‚úÖ Triggered ${triggered} collector(s). Processing may take 30-60 seconds...`);
                
                // Update button to show it's processing
                btn.innerHTML = '‚è≥ Processing (30s)...';
                
                // Wait for processing (30 seconds) then refresh
                await new Promise(resolve => setTimeout(resolve, 30000));
                
                // Refresh summaries list
                await loadSummaries();
                
                // Check if new summaries were generated
                const newSummaries = await fetch('/api/summaries?limit=5').then(r => r.json());
                const recentSummary = newSummaries[0];
                const isRecent = recentSummary && 
                    (new Date() - new Date(recentSummary.createdAt)) < 60000; // Within last minute
                
                if (isRecent) {
                    showMessage('message-summaries', `üéâ New summary generated successfully! (${recentSummary.messageIds.length} messages processed)`);
                } else {
                    showMessage('message-summaries', '‚ö†Ô∏è No new messages found to summarize. Try again later or check your collector settings.');
                }
                
            } catch (error) {
                showMessage('message-summaries', 'Error generating summary: ' + error.message, true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Load processor config
        async function loadProcessor() {
            try {
                const response = await fetch('/api/processor/config');
                const config = await response.json();
                
                document.getElementById('ollama-model').value = config.ollamaModel;
                document.getElementById('temperature').value = config.temperature;
                document.getElementById('concurrency').value = config.concurrency;
                document.getElementById('system-prompt').value = config.systemPrompt;
            } catch (error) {
                showMessage('message-processor', 'Error loading processor config', true);
            }
        }
        
        // Update processor
        async function updateProcessor(event) {
            event.preventDefault();
            
            const data = {
                ollamaModel: document.getElementById('ollama-model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                concurrency: parseInt(document.getElementById('concurrency').value),
                systemPrompt: document.getElementById('system-prompt').value
            };
            
            try {
                const response = await fetch('/api/processor/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('message-processor', 'Processor configuration updated successfully!');
                } else {
                    throw new Error('Failed to update');
                }
            } catch (error) {
                showMessage('message-processor', 'Error updating processor config', true);
            }
        }
        
        // Load interests
        async function loadInterests() {
            try {
                const response = await fetch('/api/interests');
                const interests = await response.json();
                
                const html = interests.map(i => `
                    <li class="interest-item">
                        <div>
                            <strong>${i.keyword}</strong>
                            <small style="margin-left: 1rem; opacity: 0.7;">Weight: ${i.weight}</small>
                        </div>
                        <button class="btn-danger" onclick="deleteInterest('${i.id}')">üóëÔ∏è Delete</button>
                    </li>
                `).join('');
                
                document.getElementById('interests-list').innerHTML = html || '<li>No interests yet</li>';
            } catch (error) {
                document.getElementById('interests-list').innerHTML = '<li>Error loading interests</li>';
            }
        }
        
        // Add interest
        async function addInterest(event) {
            event.preventDefault();
            
            const data = {
                keyword: document.getElementById('keyword').value,
                weight: parseFloat(document.getElementById('weight').value)
            };
            
            try {
                const response = await fetch('/api/interests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('message-interests', 'Interest added successfully!');
                    document.getElementById('interest-form').reset();
                    document.getElementById('weight').value = '1.0';
                    loadInterests();
                    loadOverview();
                } else {
                    const error = await response.json();
                    throw new Error(error.error);
                }
            } catch (error) {
                showMessage('message-interests', error.message || 'Error adding interest', true);
            }
        }
        
        // Delete interest
        async function deleteInterest(id) {
            if (!confirm('Are you sure you want to delete this interest?')) return;
            
            try {
                const response = await fetch(`/api/interests/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('message-interests', 'Interest deleted successfully!');
                    loadInterests();
                    loadOverview();
                } else {
                    throw new Error('Failed to delete');
                }
            } catch (error) {
                showMessage('message-interests', 'Error deleting interest', true);
            }
        }
        
        // Load queues
        async function loadQueues() {
            try {
                const response = await fetch('/api/queues');
                const data = await response.json();
                
                const html = data.queues.map(q => `
                    <tr>
                        <td>${q.name}</td>
                        <td>${q.waiting}</td>
                        <td>${q.active}</td>
                        <td>${q.completed}</td>
                        <td>${q.failed}</td>
                        <td><strong>${q.total}</strong></td>
                    </tr>
                `).join('');
                
                document.querySelector('#queues-table tbody').innerHTML = html;
            } catch (error) {
                document.querySelector('#queues-table tbody').innerHTML = '<tr><td colspan="6">Error loading queues</td></tr>';
            }
        }
        
        // Load overview stats
        async function loadOverview() {
            try {
                const [collectors, interests, queues, summaries] = await Promise.all([
                    fetch('/api/collectors').then(r => r.json()),
                    fetch('/api/interests').then(r => r.json()),
                    fetch('/api/queues').then(r => r.json()),
                    fetch('/api/summaries?limit=1000').then(r => r.json())
                ]);
                
                document.getElementById('stat-collectors').textContent = 
                    collectors.filter(c => c.enabled).length;
                document.getElementById('stat-interests').textContent = 
                    interests.length;
                document.getElementById('stat-jobs').textContent = 
                    queues.queues.reduce((sum, q) => sum + q.total, 0);
                document.getElementById('stat-summaries').textContent = 
                    summaries.length;
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        // Auto-refresh queues every 10 seconds
        setInterval(() => {
            if (document.getElementById('queues-tab').classList.contains('active')) {
                loadQueues();
            }
            if (document.getElementById('overview-tab').classList.contains('active')) {
                loadOverview();
            }
        }, 10000);
        
        // Initial load
        loadCollectors();
        loadOverview();
    </script>
</body>
</html>

